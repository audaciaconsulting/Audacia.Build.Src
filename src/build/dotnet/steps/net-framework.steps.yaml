# Steps to build .NET Framework Projects
parameters:
  - name: projects
    default: '**/*.csproj'
  - name: testAssemblies
    default: '**\\*test*.dll\n!**\\*TestAdapter.dll\n!**\\obj\\**'
  - name: artifactName
    default: '$(Build.DefinitionName)'
  - name: artifactPath
    default: ''
  - name: applyVersioning
    default: true
  - name: outDir
    default: '$(Build.ArtifactStagingDirectory)'

steps:
  - ${{ if eq(parameters.applyVersioning, true) }}:
    - task: UpdateDotNetVersions@12
      displayName: .NET Versioning
      inputs:
        releaseBranchNames: 'master,main'
        ExcludePreReleasePostfix: false
        workingDirectory: ''
        includeCsproj: true
        includeNuspec: false
        packageSource: 'internalPublic'
        excludePaths: '*.Tests.csproj'
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)

  - task: NuGetToolInstaller@1
    displayName: Get Nuget
    inputs:
      versionSpec: '4.9.3'

  - task: NuGetCommand@2
    displayName: 'NuGet restore'
    inputs:
      restoreSolution: ${{parameters.projects}}
      vstsFeed: 'Audacia.Public/AudaciaPublic'

  - task: MSBuild@1
    displayName: 'Build .NET'
    inputs:
      solution: '${{parameters.projects}}'
      msbuildArchitecture: 'x64'
      configuration: 'Release'
      msbuildArguments: '/p:outdir="${{parameters.outDir}}"'

  - task: VSTest@2
    displayName: 'Test Assemblies'
    inputs:
      configuration: 'Release'
      testAssemblyVer2: ${{parameters.testAssemblies}}

  - template: /src/build/common/tasks/publish.yaml
    parameters:
      artifactName: ${{parameters.artifactName}}
      path: ${{parameters.artifactPath}}